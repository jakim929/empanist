{"metadata":{"usedHelpers":["inherits","possibleConstructorReturn","classCallCheck","interopRequireDefault"],"marked":[],"modules":{"imports":[],"exports":{"exported":[],"specifiers":[]}}},"options":{"filename":"/packages/easysearch:core/lib/engines/mongo-db.js","filenameRelative":"/packages/easysearch:core/lib/engines/mongo-db.js","env":{},"retainLines":false,"highlightCode":true,"suppressDeprecationMessages":false,"presets":[],"plugins":[[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"polyfill":false}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"loose":true}],[[],{"loose":true}],[[],null],[[],{"loose":true}],[[],null],[[],null],[[],{"allowTopLevelThis":true,"strict":false,"loose":true}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"loose":true}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null]],"ignore":[],"code":true,"metadata":true,"ast":false,"comments":true,"compact":false,"minified":false,"sourceMap":true,"sourceMaps":true,"sourceMapTarget":"/packages/easysearch:core/lib/engines/mongo-db.js.map","sourceFileName":"/packages/easysearch:core/lib/engines/mongo-db.js","babelrc":false,"sourceType":"module","moduleIds":false,"passPerPreset":false,"basename":"mongo-db"},"ignored":false,"code":"var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');\n\nvar _classCallCheck3 = _interopRequireDefault(_classCallCheck2);\n\nvar _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');\n\nvar _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);\n\nvar _inherits2 = require('babel-runtime/helpers/inherits');\n\nvar _inherits3 = _interopRequireDefault(_inherits2);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }\n\n/**\n * The MongoDBEngine lets you search the index on the server side with MongoDB. Subscriptions and publications\n * are handled within the Engine.\n *\n * @type {MongoDBEngine}\n */\nMongoDBEngine = function (_ReactiveEngine) {\n  (0, _inherits3['default'])(MongoDBEngine, _ReactiveEngine);\n\n  function MongoDBEngine() {\n    (0, _classCallCheck3['default'])(this, MongoDBEngine);\n    return (0, _possibleConstructorReturn3['default'])(this, _ReactiveEngine.apply(this, arguments));\n  }\n\n  /**\n   * Return default configuration.\n   *\n   * @returns {Object}\n   */\n\n  MongoDBEngine.prototype.defaultConfiguration = function () {\n    function defaultConfiguration() {\n      return _.defaults({}, MongoDBEngine.defaultMongoConfiguration(this), _ReactiveEngine.prototype.defaultConfiguration.call(this));\n    }\n\n    return defaultConfiguration;\n  }();\n\n  /**\n   * Default mongo configuration, used in constructor and MinimongoEngine to get the configuration.\n   *\n   * @param {Object} engineScope Scope of the engine\n   *\n   * @returns {Object}\n   */\n\n\n  MongoDBEngine.defaultMongoConfiguration = function () {\n    function defaultMongoConfiguration(engineScope) {\n      return {\n        aggregation: '$or',\n        selector: function () {\n          function selector(searchObject, options, aggregation) {\n            var selector = {};\n\n            selector[aggregation] = [];\n\n            _.each(searchObject, function (searchString, field) {\n              var fieldSelector = engineScope.callConfigMethod('selectorPerField', field, searchString, options);\n\n              if (fieldSelector) {\n                selector[aggregation].push(fieldSelector);\n              }\n            });\n\n            return selector;\n          }\n\n          return selector;\n        }(),\n        selectorPerField: function () {\n          function selectorPerField(field, searchString) {\n            var selector = {};\n\n            selector[field] = { '$regex': '.*' + searchString + '.*', '$options': 'i' };\n\n            return selector;\n          }\n\n          return selectorPerField;\n        }(),\n        sort: function () {\n          function sort(searchObject, options) {\n            return options.index.fields;\n          }\n\n          return sort;\n        }()\n      };\n    }\n\n    return defaultMongoConfiguration;\n  }();\n\n  /**\n   * Return the find options for the mongo find query.\n   *\n   * @param {String} searchDefinition Search definition\n   * @param {Object} options          Search and index options\n   */\n\n\n  MongoDBEngine.prototype.getFindOptions = function () {\n    function getFindOptions(searchDefinition, options) {\n      return {\n        sort: this.callConfigMethod('sort', searchDefinition, options),\n        limit: options.search.limit,\n        skip: options.search.skip,\n        fields: this.callConfigMethod('fields', searchDefinition, options)\n      };\n    }\n\n    return getFindOptions;\n  }();\n\n  /**\n   * Return the reactive search cursor.\n   *\n   * @param {String} searchDefinition Search definition\n   * @param {Object} options          Search and index options\n   */\n\n\n  MongoDBEngine.prototype.getSearchCursor = function () {\n    function getSearchCursor(searchDefinition, options) {\n      var selector = this.callConfigMethod('selector', searchDefinition, options, this.config.aggregation),\n          findOptions = this.getFindOptions(searchDefinition, options),\n          collection = options.index.collection;\n\n      check(options, Object);\n      check(selector, Object);\n      check(findOptions, Object);\n\n      return new Cursor(collection.find(selector, findOptions), collection.find(selector).count());\n    }\n\n    return getSearchCursor;\n  }();\n\n  return MongoDBEngine;\n}(ReactiveEngine);","ast":null,"map":{"version":3,"sources":["/packages/easysearch:core/lib/engines/mongo-db.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;AAMA;6BAAsB;;;;;;;;;;;;;0BAMpB;oCAAuB;AACrB,aAAO,EAAE,QAAF,CAAW,EAAX,EAAe,cAAc,yBAAd,CAAwC,IAAxC,CAAf,EAA8D,0BAAM,oBAAN,WAA9D,CAAP,CADqB;;;;;;;;;;;;;;;AANH,gBAiBb;uCAA0B,aAAa;AAC5C,aAAO;AACL,qBAAa,KAAb;AACA;4BAAS,cAAc,SAAS,aAAa;AAC3C,gBAAI,WAAW,EAAX,CADuC;;AAG3C,qBAAS,WAAT,IAAwB,EAAxB,CAH2C;;AAK3C,cAAE,IAAF,CAAO,YAAP,EAAqB,UAAC,YAAD,EAAe,KAAf,EAAyB;AAC5C,kBAAI,gBAAgB,YAAY,gBAAZ,CAClB,kBADkB,EACE,KADF,EACS,YADT,EACuB,OADvB,CAAhB,CADwC;;AAK5C,kBAAI,aAAJ,EAAmB;AACjB,yBAAS,WAAT,EAAsB,IAAtB,CAA2B,aAA3B,EADiB;eAAnB;aALmB,CAArB,CAL2C;;AAe3C,mBAAO,QAAP,CAf2C;;;;WAFxC;AAmBL;oCAAiB,OAAO,cAAc;AACpC,gBAAI,WAAW,EAAX,CADgC;;AAGpC,qBAAS,KAAT,IAAkB,EAAE,iBAAgB,mBAAhB,EAAkC,YAAa,GAAb,EAAtD,CAHoC;;AAKpC,mBAAO,QAAP,CALoC;;;;WAnBjC;AA0BL;wBAAK,cAAc,SAAS;AAC1B,mBAAO,QAAQ,KAAR,CAAc,MAAd,CADmB;;;;WA1BvB;OAAP,CAD4C;;;;;;;;;;;;;;AAjB1B,0BAwDpB;4BAAe,kBAAkB,SAAS;AACxC,aAAO;AACL,cAAM,KAAK,gBAAL,CAAsB,MAAtB,EAA8B,gBAA9B,EAAgD,OAAhD,CAAN;AACA,eAAO,QAAQ,MAAR,CAAe,KAAf;AACP,cAAM,QAAQ,MAAR,CAAe,IAAf;AACN,gBAAQ,KAAK,gBAAL,CAAsB,QAAtB,EAAgC,gBAAhC,EAAkD,OAAlD,CAAR;OAJF,CADwC;;;;;;;;;;;;;;AAxDtB,0BAuEpB;6BAAgB,kBAAkB,SAAS;AACzC,UAAI,WAAW,KAAK,gBAAL,CAAsB,UAAtB,EAAkC,gBAAlC,EAAoD,OAApD,EAA6D,KAAK,MAAL,CAAY,WAAZ,CAAxE;UACF,cAAc,KAAK,cAAL,CAAoB,gBAApB,EAAsC,OAAtC,CAAd;UACA,aAAa,QAAQ,KAAR,CAAc,UAAd,CAH0B;;AAKzC,YAAM,OAAN,EAAe,MAAf,EALyC;AAMzC,YAAM,QAAN,EAAgB,MAAhB,EANyC;AAOzC,YAAM,WAAN,EAAmB,MAAnB,EAPyC;;AASzC,aAAO,IAAI,MAAJ,CACL,WAAW,IAAX,CAAgB,QAAhB,EAA0B,WAA1B,CADK,EAEL,WAAW,IAAX,CAAgB,QAAhB,EAA0B,KAA1B,EAFK,CAAP,CATyC;;;;;;SAvEvB;EAAsB,eAA5C","file":"/packages/easysearch:core/lib/engines/mongo-db.js.map","sourcesContent":["/**\n * The MongoDBEngine lets you search the index on the server side with MongoDB. Subscriptions and publications\n * are handled within the Engine.\n *\n * @type {MongoDBEngine}\n */\nMongoDBEngine = class MongoDBEngine extends ReactiveEngine {\n  /**\n   * Return default configuration.\n   *\n   * @returns {Object}\n   */\n  defaultConfiguration() {\n    return _.defaults({}, MongoDBEngine.defaultMongoConfiguration(this), super.defaultConfiguration());\n  }\n\n  /**\n   * Default mongo configuration, used in constructor and MinimongoEngine to get the configuration.\n   *\n   * @param {Object} engineScope Scope of the engine\n   *\n   * @returns {Object}\n   */\n  static defaultMongoConfiguration(engineScope) {\n    return {\n      aggregation: '$or',\n      selector(searchObject, options, aggregation) {\n        let selector = {};\n\n        selector[aggregation] = [];\n\n        _.each(searchObject, (searchString, field) => {\n          let fieldSelector = engineScope.callConfigMethod(\n            'selectorPerField', field, searchString, options\n          );\n\n          if (fieldSelector) {\n            selector[aggregation].push(fieldSelector);\n          }\n        });\n\n        return selector;\n      },\n      selectorPerField(field, searchString) {\n        let selector = {};\n\n        selector[field] = { '$regex' : `.*${searchString}.*`, '$options' : 'i'};\n\n        return selector\n      },\n      sort(searchObject, options) {\n        return options.index.fields;\n      }\n    };\n  }\n\n  /**\n   * Return the find options for the mongo find query.\n   *\n   * @param {String} searchDefinition Search definition\n   * @param {Object} options          Search and index options\n   */\n  getFindOptions(searchDefinition, options) {\n    return {\n      sort: this.callConfigMethod('sort', searchDefinition, options),\n      limit: options.search.limit,\n      skip: options.search.skip,\n      fields: this.callConfigMethod('fields', searchDefinition, options)\n    };\n  }\n\n  /**\n   * Return the reactive search cursor.\n   *\n   * @param {String} searchDefinition Search definition\n   * @param {Object} options          Search and index options\n   */\n  getSearchCursor(searchDefinition, options) {\n    let selector = this.callConfigMethod('selector', searchDefinition, options, this.config.aggregation),\n      findOptions = this.getFindOptions(searchDefinition, options),\n      collection = options.index.collection;\n\n    check(options, Object);\n    check(selector, Object);\n    check(findOptions, Object);\n\n    return new Cursor(\n      collection.find(selector, findOptions),\n      collection.find(selector).count()\n    );\n  }\n};\n"]},"hash":"114aeb252cb96ade204f1542d79a1002d170d141"}
