{"metadata":{"usedHelpers":[],"marked":[],"modules":{"imports":[{"source":"meteor/meteor","imported":["Meteor"],"specifiers":[{"kind":"named","imported":"Meteor","local":"Meteor"}]},{"source":"../collections/basicProfiles.js","imported":["BasicProfiles"],"specifiers":[{"kind":"named","imported":"BasicProfiles","local":"BasicProfiles"}]},{"source":"../collections/musicProfiles.js","imported":["MusicProfiles"],"specifiers":[{"kind":"named","imported":"MusicProfiles","local":"MusicProfiles"}]},{"source":"../collections/accompanistProfiles.js","imported":["AccompanistProfiles"],"specifiers":[{"kind":"named","imported":"AccompanistProfiles","local":"AccompanistProfiles"}]},{"source":"../collections/transactions.js","imported":["Transactions"],"specifiers":[{"kind":"named","imported":"Transactions","local":"Transactions"}]},{"source":"../collections/transactions.js","imported":["Sessions"],"specifiers":[{"kind":"named","imported":"Sessions","local":"Sessions"}]}],"exports":{"exported":[],"specifiers":[]}}},"options":{"filename":"/server/main.js","filenameRelative":"/server/main.js","env":{},"retainLines":false,"highlightCode":true,"suppressDeprecationMessages":false,"presets":[],"plugins":[[[],{"polyfill":false}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"loose":true}],[[],{"loose":true}],[[],null],[[],{"loose":true}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"loose":true}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null]],"ignore":[],"code":true,"metadata":true,"ast":false,"comments":true,"compact":false,"minified":false,"sourceMap":true,"sourceMaps":true,"sourceMapTarget":"/server/main.js.map","sourceFileName":"/server/main.js","babelrc":false,"sourceType":"module","moduleIds":false,"passPerPreset":false,"basename":"main"},"ignored":false,"code":"var Meteor;module.import('meteor/meteor',{\"Meteor\":function(v){Meteor=v}});var BasicProfiles;module.import('../collections/basicProfiles.js',{\"BasicProfiles\":function(v){BasicProfiles=v}});var MusicProfiles;module.import('../collections/musicProfiles.js',{\"MusicProfiles\":function(v){MusicProfiles=v}});var AccompanistProfiles;module.import('../collections/accompanistProfiles.js',{\"AccompanistProfiles\":function(v){AccompanistProfiles=v}});var Transactions;module.import('../collections/transactions.js',{\"Transactions\":function(v){Transactions=v}});var Sessions;module.import('../collections/transactions.js',{\"Sessions\":function(v){Sessions=v}});\n\n\n\n\n\n\nMeteor.startup(function () {});\n\nAWS.config.update({\n  accessKeyId: Meteor.settings.AWSAccessKeyId,\n  secretAccessKey: Meteor.settings.AWSSecretAccessKey\n});\n\nvar geo = new GeoCoder();\n\ngetGeocode = function getGeocode(arg) {\n  if (arg == 0) {\n    return null;\n  } else {\n    var result = geo.geocode(arg);\n    return result;\n  }\n};\n\nMeteor.publish('files', function () {\n  var data = Images.find({ \"userId\": this.userId });\n\n  if (data) {\n    return data;\n  }\n\n  return this.ready();\n});\n\nMeteor.methods({\n  // Add security measures\n  deleteImageFromS3: function deleteImageFromS3(imageDatabaseId) {\n    if (!this.userId) {\n      throw new Meteor.error(\"Access Denied\", \"User not logged in\");\n    } else {\n      var found = Images.findOne({ _id: imageDatabaseId, userId: this.userId });\n      if (!found) {\n        throw new Meteor.error(\"Image search failed\", \"Image not found\");\n      }\n\n      if (found.url.indexOf(\"https://empanist-images.s3.amazonaws.com/\") < 0) {\n        throw new Meteor.error(\"URL parse failed\", \"Not a valid image url\");\n      }\n\n      var newKey = found.url.replace(\"https://empanist-images.s3.amazonaws.com/\", \"\");\n      var s3 = new AWS.S3();\n\n      var params = {\n        Bucket: \"empanist-images\",\n        Key: newKey\n      };\n\n      s3.deleteObject(params, Meteor.bindEnvironment(function (err, data) {\n        if (err) {\n          console.log(err);\n        } else {\n          Images.remove({ _id: imageDatabaseId });\n          console.log(\"Successfully deleted from S3\", imageDatabaseId);\n        }\n      }));\n    }\n  },\n\n  storeUrlInDatabase: function storeUrlInDatabase(url, type) {\n    check(url, String);\n    Modules.both.checkUrlValidity(url);\n\n    try {\n      Images.insert({\n        url: url,\n        userId: Meteor.userId(),\n        picType: type,\n        added: new Date()\n      });\n    } catch (exception) {\n      return exception;\n    }\n  },\n\n  getGeocode: function getGeocode(arg) {\n    if (arg == 0) {\n      return null;\n    } else {\n      var result = geo.geocode(arg);\n      return result;\n    }\n  },\n\n  insertFullRandomProfile: function insertFullRandomProfile(userId) {\n    BasicProfiles.insert(createNewBasicProfile(userId), { getAutoValues: false });\n    MusicProfiles.insert(createNewMusicProfile(userId), { getAutoValues: false });\n    AccompanistProfiles.insert(createNewAccompanistProfile(userId), { getAutoValues: false });\n  },\n\n  insertRandomData: function insertRandomData(number) {\n    for (var i = 0; i < number; i++) {\n      var genId = Random.id();\n      BasicProfiles.insert(createNewBasicProfile(genId), { getAutoValues: false });\n      MusicProfiles.insert(createNewMusicProfile(genId), { getAutoValues: false });\n      AccompanistProfiles.insert(createNewAccompanistProfile(genId), { getAutoValues: false });\n    }\n  },\n\n  insertRandomTransactions: function insertRandomTransactions(number, userId) {\n    for (var i = 0; i < number; i++) {\n      Transactions.insert(createNewTransaction(userId));\n    }\n  },\n\n  divinify: function divinify(userId) {\n    Roles.addUsersToRoles(userId, 'admin');\n  },\n\n  confirmBookingRequest: function confirmBookingRequest(transactionId) {\n    var transaction = Transactions.findOne({ _id: transactionId });\n    if (transaction) {\n      if (transaction.accompanist == this.userId) {\n        var firstSession = Sessions.findOne({ transaction: transactionId });\n        console.log(firstSession);\n        if (firstSession.startTime) {\n          Transactions.update({ _id: transactionId }, { $set: { status: \"Ongoing\" } });\n        } else {\n          Meteor.Error(\"First session not set yet.\");\n        }\n      } else {\n        Meteor.Error(\"No permission to confirm booking.\");\n      }\n    } else {\n      Meteor.Error(\"No such transaction.\");\n    }\n  }\n\n});\n\n// Server Side hooks\n// CHANGE ADMIN SETTINGS WHEN DONE TESTING\n\nMeteor.users.after.insert(function (userId, doc) {\n  Roles.addUsersToRoles(this._id, 'makeBasicProfile');\n});\n\n// Basic Profiles Server Side Hooks\n\nBasicProfiles.before.insert(function (userId, doc) {\n  var loggedInUser = Meteor.user();\n  if (!loggedInUser) {\n    throw new Meteor.Error(403, \"Not Logged In\");\n  } else if (!Roles.userIsInRole(loggedInUser._id, 'makeBasicProfile') && !Roles.userIsInRole(loggedInUser._id, 'admin')) {\n    throw new Meteor.Error(403, \"No Permission to Make Basic Profile\");\n  }\n});\n\nBasicProfiles.after.insert(function (userId, doc) {\n  console.log(\"Basic Profile Made for\", doc.userId);\n  Roles.addUsersToRoles(doc.userId, 'makeMusicProfile');\n  Roles.addUsersToRoles(doc.userId, 'bookAccompanist');\n});\n\n// Music Profile Server Side Hooks\n\nMusicProfiles.before.insert(function (userId, doc) {\n  var loggedInUser = Meteor.user();\n  if (!loggedInUser) {\n    throw new Meteor.Error(403, \"Not Logged In\");\n  } else if (!Roles.userIsInRole(loggedInUser._id, 'makeMusicProfile') && !Roles.userIsInRole(loggedInUser._id, 'admin')) {\n    throw new Meteor.Error(403, \"No Permission to Make Music Profile\");\n  }\n});\n\nMusicProfiles.after.insert(function (userId, doc) {\n  Roles.addUsersToRoles(doc.userId, ['becomeAccompanist', 'musician']);\n});\n\n// Accompanist Profile Server Side Hooks\n\nAccompanistProfiles.before.insert(function (userId, doc) {\n  var loggedInUser = Meteor.user();\n  if (!loggedInUser) {\n    throw new Meteor.Error(403, \"Not Logged In\");\n  } else if (!Roles.userIsInRole(loggedInUser._id, 'becomeAccompanist') && !Roles.userIsInRole(loggedInUser._id, 'admin')) {\n    throw new Meteor.Error(403, \"Must first make Music Profile\");\n  }\n});\n\nAccompanistProfiles.after.insert(function (userId, doc) {\n  var address = doc.mylocation;\n  var coded = getGeocode(address);\n\n  var lat = Number(coded[0].latitude);\n  var lng = Number(coded[0].longitude);\n  var coords_new = [lng, lat];\n  console.log(\"working Insert\");\n  AccompanistProfiles.update({ _id: doc._id }, { $set: { geolocation: coded[0], loc: { 'type': \"Point\", 'coordinates': coords_new } } }, { getAutoValues: false });\n  Roles.addUsersToRoles(userId, 'accompanist');\n});\n\nAccompanistProfiles.after.update(function (userId, doc, fieldNames, modifier, options) {\n\n  var address = doc.mylocation;\n\n  // take if outside to make more efficient!!!!!\n  var result = getGeocode(address);\n\n  var lat = Number(result[0].latitude);\n  var lng = Number(result[0].longitude);\n  var coords_new = [lng, lat];\n  var coords_db = doc.loc.coordinates;\n\n  if (coords_new[0] !== coords_db[0] && coords_new[1] !== coords_db[1]) {\n    console.log(\"updating\");\n    AccompanistProfiles.update({ _id: doc._id }, { $set: { geolocation: result[0], loc: { 'type': \"Point\", 'coordinates': coords_new } } }, { getAutoValues: false });\n  }\n  console.log(\"working_UPDATE nothing done\");\n}, { fetchPrevious: true });","ast":null,"map":{"version":3,"sources":["/server/main.js"],"names":[],"mappings":"AAAA,SAAS,MAAT,QAAuB,eAAvB;AACA,SAAS,aAAT,QAA8B,iCAA9B;AACA,SAAS,aAAT,QAA8B,iCAA9B;AACA,SAAS,mBAAT,QAAoC,uCAApC;AACA,SAAS,YAAT,QAA6B,gCAA7B;AACA,SAAS,QAAT,QAAyB,gCAAzB;;AAEA,OAAO,OAAP,CAAe,YAAM,CACpB,CADD;;AAGA,IAAI,MAAJ,CAAW,MAAX,CAAkB;AAChB,eAAa,OAAO,QAAP,CAAgB,cADb;AAEhB,mBAAiB,OAAO,QAAP,CAAgB;AAFjB,CAAlB;;AAOA,IAAI,MAAM,IAAI,QAAJ,EAAV;;AAEA,aAAa,oBAAU,GAAV,EAAe;AAC1B,MAAI,OAAO,CAAX,EAAa;AACX,WAAO,IAAP;AACD,GAFD,MAEO;AACL,QAAI,SAAS,IAAI,OAAJ,CAAY,GAAZ,CAAb;AACA,WAAO,MAAP;AACD;AACF,CAPD;;AAUA,OAAO,OAAP,CAAgB,OAAhB,EAAyB,YAAU;AACjC,MAAI,OAAO,OAAO,IAAP,CAAa,EAAE,UAAU,KAAK,MAAjB,EAAb,CAAX;;AAEA,MAAK,IAAL,EAAY;AACV,WAAO,IAAP;AACD;;AAED,SAAO,KAAK,KAAL,EAAP;AACD,CARD;;AAWA,OAAO,OAAP,CAAe;;AAEb,qBAAmB,2BAAS,eAAT,EAAyB;AAC1C,QAAG,CAAC,KAAK,MAAT,EAAgB;AACd,YAAM,IAAI,OAAO,KAAX,CAAiB,eAAjB,EAAiC,oBAAjC,CAAN;AACD,KAFD,MAEK;AACH,UAAI,QAAQ,OAAO,OAAP,CAAe,EAAC,KAAK,eAAN,EAAuB,QAAQ,KAAK,MAApC,EAAf,CAAZ;AACA,UAAI,CAAC,KAAL,EAAW;AACT,cAAM,IAAI,OAAO,KAAX,CAAiB,qBAAjB,EAAuC,iBAAvC,CAAN;AACD;;AAED,UAAI,MAAM,GAAN,CAAU,OAAV,CAAkB,2CAAlB,IAAiE,CAArE,EACA;AACE,cAAM,IAAI,OAAO,KAAX,CAAiB,kBAAjB,EAAoC,uBAApC,CAAN;AACD;;AAED,UAAI,SAAS,MAAM,GAAN,CAAU,OAAV,CAAkB,2CAAlB,EAA+D,EAA/D,CAAb;AACA,UAAI,KAAK,IAAI,IAAI,EAAR,EAAT;;AAEA,UAAI,SAAS;AACX,gBAAQ,iBADG;AAEX,aAAI;AAFO,OAAb;;AAKA,SAAG,YAAH,CAAgB,MAAhB,EAAwB,OAAO,eAAP,CAAuB,UAAS,GAAT,EAAa,IAAb,EAAkB;AAC/D,YAAI,GAAJ,EAAQ;AACN,kBAAQ,GAAR,CAAY,GAAZ;AACD,SAFD,MAEK;AACH,iBAAO,MAAP,CAAc,EAAC,KAAK,eAAN,EAAd;AACA,kBAAQ,GAAR,CAAY,8BAAZ,EAA4C,eAA5C;AACD;AACF,OAPuB,CAAxB;AAQD;AAEF,GAlCY;;AAoCb,sBAAoB,4BAAU,GAAV,EAAe,IAAf,EAAsB;AACxC,UAAO,GAAP,EAAY,MAAZ;AACA,YAAQ,IAAR,CAAa,gBAAb,CAA+B,GAA/B;;AAEA,QAAI;AACF,aAAO,MAAP,CAAc;AACZ,aAAK,GADO;AAEZ,gBAAQ,OAAO,MAAP,EAFI;AAGZ,iBAAS,IAHG;AAIZ,eAAO,IAAI,IAAJ;AAJK,OAAd;AAMD,KAPD,CAOE,OAAO,SAAP,EAAmB;AACnB,aAAO,SAAP;AACD;AACF,GAlDY;;AAoDb,cAAY,oBAAU,GAAV,EAAe;AACzB,QAAI,OAAO,CAAX,EAAa;AACX,aAAO,IAAP;AACD,KAFD,MAEO;AACL,UAAI,SAAS,IAAI,OAAJ,CAAY,GAAZ,CAAb;AACA,aAAO,MAAP;AACD;AACF,GA3DY;;AA6Db,2BAAyB,iCAAS,MAAT,EAAgB;AACvC,kBAAc,MAAd,CAAqB,sBAAsB,MAAtB,CAArB,EAAoD,EAAC,eAAe,KAAhB,EAApD;AACA,kBAAc,MAAd,CAAqB,sBAAsB,MAAtB,CAArB,EAAoD,EAAC,eAAe,KAAhB,EAApD;AACA,wBAAoB,MAApB,CAA2B,4BAA4B,MAA5B,CAA3B,EAAgE,EAAC,eAAe,KAAhB,EAAhE;AACD,GAjEY;;AAmEb,oBAAkB,0BAAS,MAAT,EAAiB;AACjC,SAAK,IAAI,IAAI,CAAb,EAAgB,IAAI,MAApB,EAA4B,GAA5B,EAAgC;AAC9B,UAAI,QAAQ,OAAO,EAAP,EAAZ;AACA,oBAAc,MAAd,CAAqB,sBAAsB,KAAtB,CAArB,EAAmD,EAAC,eAAe,KAAhB,EAAnD;AACA,oBAAc,MAAd,CAAqB,sBAAsB,KAAtB,CAArB,EAAmD,EAAC,eAAe,KAAhB,EAAnD;AACA,0BAAoB,MAApB,CAA2B,4BAA4B,KAA5B,CAA3B,EAA+D,EAAC,eAAe,KAAhB,EAA/D;AACD;AACF,GA1EY;;AA4Eb,4BAA0B,kCAAS,MAAT,EAAiB,MAAjB,EAAyB;AACjD,SAAK,IAAI,IAAI,CAAb,EAAgB,IAAI,MAApB,EAA4B,GAA5B,EAAgC;AAC9B,mBAAa,MAAb,CAAoB,qBAAqB,MAArB,CAApB;AACD;AACF,GAhFY;;AAkFb,YAAU,kBAAS,MAAT,EAAiB;AACzB,UAAM,eAAN,CAAsB,MAAtB,EAA8B,OAA9B;AACD,GApFY;;AAsFb,yBAAuB,+BAAS,aAAT,EAAwB;AAC7C,QAAI,cAAc,aAAa,OAAb,CAAqB,EAAC,KAAK,aAAN,EAArB,CAAlB;AACA,QAAG,WAAH,EAAe;AACb,UAAG,YAAY,WAAZ,IAA2B,KAAK,MAAnC,EAA0C;AACxC,YAAI,eAAe,SAAS,OAAT,CAAiB,EAAC,aAAa,aAAd,EAAjB,CAAnB;AACA,gBAAQ,GAAR,CAAY,YAAZ;AACA,YAAG,aAAa,SAAhB,EAA0B;AACxB,uBAAa,MAAb,CAAoB,EAAC,KAAK,aAAN,EAApB,EAA0C,EAAC,MAAM,EAAC,QAAQ,SAAT,EAAP,EAA1C;AACD,SAFD,MAGI;AACF,iBAAO,KAAP,CAAa,4BAAb;AACD;AACF,OATD,MAUI;AACF,eAAO,KAAP,CAAa,mCAAb;AACD;AACF,KAdD,MAcK;AACH,aAAO,KAAP,CAAa,sBAAb;AACD;AACF;;AAzGY,CAAf;;;;;AAgHA,OAAO,KAAP,CAAa,KAAb,CAAmB,MAAnB,CAA0B,UAAU,MAAV,EAAkB,GAAlB,EAAsB;AAC9C,QAAM,eAAN,CAAsB,KAAK,GAA3B,EAAgC,kBAAhC;AACD,CAFD;;;;AAMA,cAAc,MAAd,CAAqB,MAArB,CAA4B,UAAU,MAAV,EAAkB,GAAlB,EAAsB;AAChD,MAAI,eAAe,OAAO,IAAP,EAAnB;AACA,MAAG,CAAC,YAAJ,EAAiB;AACf,UAAM,IAAI,OAAO,KAAX,CAAiB,GAAjB,EAAsB,eAAtB,CAAN;AACD,GAFD,MAEM,IAAI,CAAC,MAAM,YAAN,CAAmB,aAAa,GAAhC,EAAqC,kBAArC,CAAF,IACI,CAAC,MAAM,YAAN,CAAmB,aAAa,GAAhC,EAAqC,OAArC,CADR,EACuD;AAC3D,UAAM,IAAI,OAAO,KAAX,CAAiB,GAAjB,EAAsB,qCAAtB,CAAN;AACD;AACF,CARD;;AAUA,cAAc,KAAd,CAAoB,MAApB,CAA2B,UAAS,MAAT,EAAiB,GAAjB,EAAqB;AAC9C,UAAQ,GAAR,CAAY,wBAAZ,EAAqC,IAAI,MAAzC;AACA,QAAM,eAAN,CAAsB,IAAI,MAA1B,EAAkC,kBAAlC;AACA,QAAM,eAAN,CAAsB,IAAI,MAA1B,EAAkC,iBAAlC;AACD,CAJD;;;;AASA,cAAc,MAAd,CAAqB,MAArB,CAA4B,UAAU,MAAV,EAAkB,GAAlB,EAAsB;AAChD,MAAI,eAAe,OAAO,IAAP,EAAnB;AACA,MAAG,CAAC,YAAJ,EAAiB;AACf,UAAM,IAAI,OAAO,KAAX,CAAiB,GAAjB,EAAsB,eAAtB,CAAN;AACD,GAFD,MAEM,IAAI,CAAC,MAAM,YAAN,CAAmB,aAAa,GAAhC,EAAqC,kBAArC,CAAF,IACI,CAAC,MAAM,YAAN,CAAmB,aAAa,GAAhC,EAAqC,OAArC,CADR,EACuD;AAC3D,UAAM,IAAI,OAAO,KAAX,CAAiB,GAAjB,EAAsB,qCAAtB,CAAN;AACD;AACF,CARD;;AAUA,cAAc,KAAd,CAAoB,MAApB,CAA2B,UAAS,MAAT,EAAiB,GAAjB,EAAqB;AAC9C,QAAM,eAAN,CAAsB,IAAI,MAA1B,EAAkC,CAAC,mBAAD,EAAsB,UAAtB,CAAlC;AACD,CAFD;;;;AAQA,oBAAoB,MAApB,CAA2B,MAA3B,CAAkC,UAAU,MAAV,EAAkB,GAAlB,EAAsB;AACtD,MAAI,eAAe,OAAO,IAAP,EAAnB;AACA,MAAG,CAAC,YAAJ,EAAiB;AACf,UAAM,IAAI,OAAO,KAAX,CAAiB,GAAjB,EAAsB,eAAtB,CAAN;AACD,GAFD,MAEM,IAAI,CAAC,MAAM,YAAN,CAAmB,aAAa,GAAhC,EAAqC,mBAArC,CAAF,IACI,CAAC,MAAM,YAAN,CAAmB,aAAa,GAAhC,EAAqC,OAArC,CADR,EACuD;AAC3D,UAAM,IAAI,OAAO,KAAX,CAAiB,GAAjB,EAAsB,+BAAtB,CAAN;AACD;AACF,CARD;;AAUA,oBAAoB,KAApB,CAA0B,MAA1B,CAAiC,UAAU,MAAV,EAAkB,GAAlB,EAAuB;AACtD,MAAI,UAAU,IAAI,UAAlB;AACA,MAAI,QAAQ,WAAW,OAAX,CAAZ;;AAEA,MAAI,MAAM,OAAO,MAAM,CAAN,EAAS,QAAhB,CAAV;AACA,MAAI,MAAM,OAAO,MAAM,CAAN,EAAS,SAAhB,CAAV;AACA,MAAI,aAAa,CAAC,GAAD,EAAM,GAAN,CAAjB;AACA,UAAQ,GAAR,CAAY,gBAAZ;AACA,sBAAoB,MAApB,CAA2B,EAAC,KAAK,IAAI,GAAV,EAA3B,EAA2C,EAAC,MAAM,EAAC,aAAc,MAAM,CAAN,CAAf,EAAyB,KAAK,EAAC,QAAQ,OAAT,EAAkB,eAAgB,UAAlC,EAA9B,EAAP,EAA3C,EAAgI,EAAC,eAAe,KAAhB,EAAhI;AACA,QAAM,eAAN,CAAsB,MAAtB,EAA8B,aAA9B;AACD,CAVD;;AAYA,oBAAoB,KAApB,CAA0B,MAA1B,CAAiC,UAAU,MAAV,EAAkB,GAAlB,EAAuB,UAAvB,EAAmC,QAAnC,EAA6C,OAA7C,EAAsD;;AAErF,MAAI,UAAU,IAAI,UAAlB;;;AAGA,MAAI,SAAS,WAAW,OAAX,CAAb;;AAEA,MAAI,MAAM,OAAO,OAAO,CAAP,EAAU,QAAjB,CAAV;AACA,MAAI,MAAM,OAAO,OAAO,CAAP,EAAU,SAAjB,CAAV;AACA,MAAI,aAAa,CAAC,GAAD,EAAM,GAAN,CAAjB;AACA,MAAI,YAAY,IAAI,GAAJ,CAAQ,WAAxB;;AAEA,MAAI,WAAW,CAAX,MAAkB,UAAU,CAAV,CAAlB,IAAkC,WAAW,CAAX,MAAkB,UAAU,CAAV,CAAxD,EAAsE;AACpE,YAAQ,GAAR,CAAY,UAAZ;AACA,wBAAoB,MAApB,CAA2B,EAAC,KAAK,IAAI,GAAV,EAA3B,EAA2C,EAAC,MAAM,EAAC,aAAc,OAAO,CAAP,CAAf,EAA0B,KAAK,EAAC,QAAQ,OAAT,EAAkB,eAAgB,UAAlC,EAA/B,EAAP,EAA3C,EAC4B,EAAC,eAAe,KAAhB,EAD5B;AAED;AACD,UAAQ,GAAR,CAAY,6BAAZ;AAED,CAnBD,EAmBG,EAAC,eAAe,IAAhB,EAnBH","file":"/server/main.js.map","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport { BasicProfiles } from '../collections/basicProfiles.js'\nimport { MusicProfiles } from '../collections/musicProfiles.js'\nimport { AccompanistProfiles } from '../collections/accompanistProfiles.js'\nimport { Transactions } from '../collections/transactions.js'\nimport { Sessions } from '../collections/transactions.js'\n\nMeteor.startup(() => {\n});\n\nAWS.config.update({\n  accessKeyId: Meteor.settings.AWSAccessKeyId,\n  secretAccessKey: Meteor.settings.AWSSecretAccessKey\n});\n\n\n\nvar geo = new GeoCoder();\n\ngetGeocode = function (arg) {\n  if (arg == 0){\n    return null\n  } else {\n    var result = geo.geocode(arg);\n    return result\n  }\n};\n\n\nMeteor.publish( 'files', function(){\n  var data = Images.find( { \"userId\": this.userId } );\n\n  if ( data ) {\n    return data;\n  }\n\n  return this.ready();\n});\n\n\nMeteor.methods({\n  // Add security measures\n  deleteImageFromS3: function(imageDatabaseId){\n    if(!this.userId){\n      throw new Meteor.error(\"Access Denied\",\"User not logged in\");\n    }else{\n      var found = Images.findOne({_id: imageDatabaseId, userId: this.userId})\n      if (!found){\n        throw new Meteor.error(\"Image search failed\",\"Image not found\");\n      }\n\n      if (found.url.indexOf(\"https://empanist-images.s3.amazonaws.com/\") < 0)\n      {\n        throw new Meteor.error(\"URL parse failed\",\"Not a valid image url\");\n      }\n\n      var newKey = found.url.replace(\"https://empanist-images.s3.amazonaws.com/\", \"\")\n      var s3 = new AWS.S3();\n\n      var params = {\n        Bucket: \"empanist-images\",\n        Key:newKey\n      };\n\n      s3.deleteObject(params, Meteor.bindEnvironment(function(err,data){\n        if (err){\n          console.log(err)\n        }else{\n          Images.remove({_id: imageDatabaseId});\n          console.log(\"Successfully deleted from S3\", imageDatabaseId);\n        }\n      }))\n    }\n\n  },\n\n  storeUrlInDatabase: function( url, type ) {\n    check( url, String );\n    Modules.both.checkUrlValidity( url );\n\n    try {\n      Images.insert({\n        url: url,\n        userId: Meteor.userId(),\n        picType: type,\n        added: new Date()\n      });\n    } catch( exception ) {\n      return exception;\n    }\n  },\n\n  getGeocode: function (arg) {\n    if (arg == 0){\n      return null\n    } else {\n      var result = geo.geocode(arg);\n      return result\n    }\n  },\n\n  insertFullRandomProfile: function(userId){\n    BasicProfiles.insert(createNewBasicProfile(userId), {getAutoValues: false});\n    MusicProfiles.insert(createNewMusicProfile(userId), {getAutoValues: false});\n    AccompanistProfiles.insert(createNewAccompanistProfile(userId), {getAutoValues: false});\n  },\n\n  insertRandomData: function(number) {\n    for (var i = 0; i < number; i++){\n      var genId = Random.id();\n      BasicProfiles.insert(createNewBasicProfile(genId), {getAutoValues: false});\n      MusicProfiles.insert(createNewMusicProfile(genId), {getAutoValues: false});\n      AccompanistProfiles.insert(createNewAccompanistProfile(genId), {getAutoValues: false});\n    }\n  },\n\n  insertRandomTransactions: function(number, userId) {\n    for (var i = 0; i < number; i++){\n      Transactions.insert(createNewTransaction(userId));\n    }\n  },\n\n  divinify: function(userId) {\n    Roles.addUsersToRoles(userId, 'admin');\n  },\n\n  confirmBookingRequest: function(transactionId) {\n    var transaction = Transactions.findOne({_id: transactionId});\n    if(transaction){\n      if(transaction.accompanist == this.userId){\n        var firstSession = Sessions.findOne({transaction: transactionId});\n        console.log(firstSession)\n        if(firstSession.startTime){\n          Transactions.update({_id: transactionId}, {$set: {status: \"Ongoing\"}});\n        }\n        else{\n          Meteor.Error(\"First session not set yet.\")\n        }\n      }\n      else{\n        Meteor.Error(\"No permission to confirm booking.\")\n      }\n    }else{\n      Meteor.Error(\"No such transaction.\")\n    }\n  }\n\n});\n\n// Server Side hooks\n// CHANGE ADMIN SETTINGS WHEN DONE TESTING\n\nMeteor.users.after.insert(function (userId, doc){\n  Roles.addUsersToRoles(this._id, 'makeBasicProfile');\n});\n\n// Basic Profiles Server Side Hooks\n\nBasicProfiles.before.insert(function (userId, doc){\n  var loggedInUser = Meteor.user();\n  if(!loggedInUser){\n    throw new Meteor.Error(403, \"Not Logged In\");\n  }else if((!Roles.userIsInRole(loggedInUser._id, 'makeBasicProfile'))\n            &&(!Roles.userIsInRole(loggedInUser._id, 'admin'))){\n    throw new Meteor.Error(403, \"No Permission to Make Basic Profile\");\n  }\n});\n\nBasicProfiles.after.insert(function(userId, doc){\n  console.log(\"Basic Profile Made for\",doc.userId);\n  Roles.addUsersToRoles(doc.userId, 'makeMusicProfile');\n  Roles.addUsersToRoles(doc.userId, 'bookAccompanist');\n});\n\n\n// Music Profile Server Side Hooks\n\nMusicProfiles.before.insert(function (userId, doc){\n  var loggedInUser = Meteor.user();\n  if(!loggedInUser){\n    throw new Meteor.Error(403, \"Not Logged In\");\n  }else if((!Roles.userIsInRole(loggedInUser._id, 'makeMusicProfile'))\n            &&(!Roles.userIsInRole(loggedInUser._id, 'admin'))){\n    throw new Meteor.Error(403, \"No Permission to Make Music Profile\");\n  }\n});\n\nMusicProfiles.after.insert(function(userId, doc){\n  Roles.addUsersToRoles(doc.userId, ['becomeAccompanist', 'musician']);\n});\n\n\n\n// Accompanist Profile Server Side Hooks\n\nAccompanistProfiles.before.insert(function (userId, doc){\n  var loggedInUser = Meteor.user();\n  if(!loggedInUser){\n    throw new Meteor.Error(403, \"Not Logged In\");\n  }else if((!Roles.userIsInRole(loggedInUser._id, 'becomeAccompanist'))\n            &&(!Roles.userIsInRole(loggedInUser._id, 'admin'))){\n    throw new Meteor.Error(403, \"Must first make Music Profile\");\n  }\n});\n\nAccompanistProfiles.after.insert(function (userId, doc) {\n  var address = doc.mylocation;\n  var coded = getGeocode(address);\n\n  var lat = Number(coded[0].latitude);\n  var lng = Number(coded[0].longitude);\n  var coords_new = [lng, lat];\n  console.log(\"working Insert\")\n  AccompanistProfiles.update({_id: doc._id}, {$set: {geolocation : coded[0], loc: {'type': \"Point\", 'coordinates' : coords_new}}},{getAutoValues: false});\n  Roles.addUsersToRoles(userId, 'accompanist');\n});\n\nAccompanistProfiles.after.update(function (userId, doc, fieldNames, modifier, options) {\n\n  var address = doc.mylocation;\n\n  // take if outside to make more efficient!!!!!\n  var result = getGeocode(address);\n\n  var lat = Number(result[0].latitude);\n  var lng = Number(result[0].longitude);\n  var coords_new = [lng, lat];\n  var coords_db = doc.loc.coordinates\n\n  if (coords_new[0] !== coords_db[0] && coords_new[1] !== coords_db[1]) {\n    console.log(\"updating\")\n    AccompanistProfiles.update({_id: doc._id}, {$set: {geolocation : result[0], loc: {'type': \"Point\", 'coordinates' : coords_new}}},\n                                {getAutoValues: false});\n  }\n  console.log(\"working_UPDATE nothing done\")\n\n}, {fetchPrevious: true});\n"]},"hash":"e1e2b35d6f2e483984c777a5d21a65913b4a223c"}
