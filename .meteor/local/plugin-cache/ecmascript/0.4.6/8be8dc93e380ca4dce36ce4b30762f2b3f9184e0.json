{"metadata":{"usedHelpers":["inherits","possibleConstructorReturn","classCallCheck","interopRequireDefault"],"marked":[],"modules":{"imports":[],"exports":{"exported":[],"specifiers":[]}}},"options":{"filename":"/packages/easysearch:core/lib/engines/mongo-db.js","filenameRelative":"/packages/easysearch:core/lib/engines/mongo-db.js","env":{},"retainLines":false,"highlightCode":true,"suppressDeprecationMessages":false,"presets":[],"plugins":[[[],{"polyfill":false}],[[],null],[[],null],[[],{"allowTopLevelThis":true,"strict":false,"loose":true}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"loose":true}],[[],{"loose":true}],[[],null],[[],{"loose":true}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"loose":true}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null]],"ignore":[],"code":true,"metadata":true,"ast":false,"comments":true,"compact":false,"minified":false,"sourceMap":true,"sourceMaps":true,"sourceMapTarget":"/packages/easysearch:core/lib/engines/mongo-db.js.map","sourceFileName":"/packages/easysearch:core/lib/engines/mongo-db.js","babelrc":false,"sourceType":"module","moduleIds":false,"passPerPreset":false,"basename":"mongo-db"},"ignored":false,"code":"var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');\n\nvar _classCallCheck3 = _interopRequireDefault(_classCallCheck2);\n\nvar _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');\n\nvar _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);\n\nvar _inherits2 = require('babel-runtime/helpers/inherits');\n\nvar _inherits3 = _interopRequireDefault(_inherits2);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }\n\n/**\n * The MongoDBEngine lets you search the index on the server side with MongoDB. Subscriptions and publications\n * are handled within the Engine.\n *\n * @type {MongoDBEngine}\n */\nMongoDBEngine = function (_ReactiveEngine) {\n  (0, _inherits3['default'])(MongoDBEngine, _ReactiveEngine);\n\n  function MongoDBEngine() {\n    (0, _classCallCheck3['default'])(this, MongoDBEngine);\n    return (0, _possibleConstructorReturn3['default'])(this, _ReactiveEngine.apply(this, arguments));\n  }\n\n  /**\n   * Return default configuration.\n   *\n   * @returns {Object}\n   */\n\n  MongoDBEngine.prototype.defaultConfiguration = function () {\n    function defaultConfiguration() {\n      return _.defaults({}, MongoDBEngine.defaultMongoConfiguration(this), _ReactiveEngine.prototype.defaultConfiguration.call(this));\n    }\n\n    return defaultConfiguration;\n  }();\n\n  /**\n   * Default mongo configuration, used in constructor and MinimongoEngine to get the configuration.\n   *\n   * @param {Object} engineScope Scope of the engine\n   *\n   * @returns {Object}\n   */\n\n\n  MongoDBEngine.defaultMongoConfiguration = function () {\n    function defaultMongoConfiguration(engineScope) {\n      return {\n        aggregation: '$or',\n        selector: function () {\n          function selector(searchObject, options, aggregation) {\n            var selector = {};\n\n            selector[aggregation] = [];\n\n            _.each(searchObject, function (searchString, field) {\n              var fieldSelector = engineScope.callConfigMethod('selectorPerField', field, searchString, options);\n\n              if (fieldSelector) {\n                selector[aggregation].push(fieldSelector);\n              }\n            });\n\n            return selector;\n          }\n\n          return selector;\n        }(),\n        selectorPerField: function () {\n          function selectorPerField(field, searchString) {\n            var selector = {};\n\n            selector[field] = { '$regex': '.*' + searchString + '.*', '$options': 'i' };\n\n            return selector;\n          }\n\n          return selectorPerField;\n        }(),\n        sort: function () {\n          function sort(searchObject, options) {\n            return options.index.fields;\n          }\n\n          return sort;\n        }()\n      };\n    }\n\n    return defaultMongoConfiguration;\n  }();\n\n  /**\n   * Return the find options for the mongo find query.\n   *\n   * @param {String} searchDefinition Search definition\n   * @param {Object} options          Search and index options\n   */\n\n\n  MongoDBEngine.prototype.getFindOptions = function () {\n    function getFindOptions(searchDefinition, options) {\n      return {\n        sort: this.callConfigMethod('sort', searchDefinition, options),\n        limit: options.search.limit,\n        skip: options.search.skip,\n        fields: this.callConfigMethod('fields', searchDefinition, options)\n      };\n    }\n\n    return getFindOptions;\n  }();\n\n  /**\n   * Return the reactive search cursor.\n   *\n   * @param {String} searchDefinition Search definition\n   * @param {Object} options          Search and index options\n   */\n\n\n  MongoDBEngine.prototype.getSearchCursor = function () {\n    function getSearchCursor(searchDefinition, options) {\n      var selector = this.callConfigMethod('selector', searchDefinition, options, this.config.aggregation),\n          findOptions = this.getFindOptions(searchDefinition, options),\n          collection = options.index.collection;\n\n      check(options, Object);\n      check(selector, Object);\n      check(findOptions, Object);\n\n      return new Cursor(collection.find(selector, findOptions), collection.find(selector).count());\n    }\n\n    return getSearchCursor;\n  }();\n\n  return MongoDBEngine;\n}(ReactiveEngine);","ast":null,"map":{"version":3,"sources":["/packages/easysearch:core/lib/engines/mongo-db.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;AAMA;AAAA;;AAAA;AAAA;AAAA;AAAA;;;;;;;;AAAA,0BAME,oBANF;AAAA,oCAMyB;AACrB,aAAO,EAAE,QAAF,CAAW,EAAX,EAAe,cAAc,yBAAd,CAAwC,IAAxC,CAAf,EAA8D,0BAAM,oBAAN,WAA9D,CAAP;AACD;;AARH;AAAA;;;;;;;;;;;AAAA,gBAiBS,yBAjBT;AAAA,uCAiBmC,WAjBnC,EAiBgD;AAC5C,aAAO;AACL,qBAAa,KADR;AAEL,gBAFK;AAAA,4BAEI,YAFJ,EAEkB,OAFlB,EAE2B,WAF3B,EAEwC;AAC3C,gBAAI,WAAW,EAAf;;AAEA,qBAAS,WAAT,IAAwB,EAAxB;;AAEA,cAAE,IAAF,CAAO,YAAP,EAAqB,UAAC,YAAD,EAAe,KAAf,EAAyB;AAC5C,kBAAI,gBAAgB,YAAY,gBAAZ,CAClB,kBADkB,EACE,KADF,EACS,YADT,EACuB,OADvB,CAApB;;AAIA,kBAAI,aAAJ,EAAmB;AACjB,yBAAS,WAAT,EAAsB,IAAtB,CAA2B,aAA3B;AACD;AACF,aARD;;AAUA,mBAAO,QAAP;AACD;;AAlBI;AAAA;AAmBL,wBAnBK;AAAA,oCAmBY,KAnBZ,EAmBmB,YAnBnB,EAmBiC;AACpC,gBAAI,WAAW,EAAf;;AAEA,qBAAS,KAAT,IAAkB,EAAE,iBAAgB,YAAhB,OAAF,EAAoC,YAAa,GAAjD,EAAlB;;AAEA,mBAAO,QAAP;AACD;;AAzBI;AAAA;AA0BL,YA1BK;AAAA,wBA0BA,YA1BA,EA0Bc,OA1Bd,EA0BuB;AAC1B,mBAAO,QAAQ,KAAR,CAAc,MAArB;AACD;;AA5BI;AAAA;AAAA,OAAP;AA8BD;;AAhDH;AAAA;;;;;;;;;;AAAA,0BAwDE,cAxDF;AAAA,4BAwDiB,gBAxDjB,EAwDmC,OAxDnC,EAwD4C;AACxC,aAAO;AACL,cAAM,KAAK,gBAAL,CAAsB,MAAtB,EAA8B,gBAA9B,EAAgD,OAAhD,CADD;AAEL,eAAO,QAAQ,MAAR,CAAe,KAFjB;AAGL,cAAM,QAAQ,MAAR,CAAe,IAHhB;AAIL,gBAAQ,KAAK,gBAAL,CAAsB,QAAtB,EAAgC,gBAAhC,EAAkD,OAAlD;AAJH,OAAP;AAMD;;AA/DH;AAAA;;;;;;;;;;AAAA,0BAuEE,eAvEF;AAAA,6BAuEkB,gBAvElB,EAuEoC,OAvEpC,EAuE6C;AACzC,UAAI,WAAW,KAAK,gBAAL,CAAsB,UAAtB,EAAkC,gBAAlC,EAAoD,OAApD,EAA6D,KAAK,MAAL,CAAY,WAAzE,CAAf;AAAA,UACE,cAAc,KAAK,cAAL,CAAoB,gBAApB,EAAsC,OAAtC,CADhB;AAAA,UAEE,aAAa,QAAQ,KAAR,CAAc,UAF7B;;AAIA,YAAM,OAAN,EAAe,MAAf;AACA,YAAM,QAAN,EAAgB,MAAhB;AACA,YAAM,WAAN,EAAmB,MAAnB;;AAEA,aAAO,IAAI,MAAJ,CACL,WAAW,IAAX,CAAgB,QAAhB,EAA0B,WAA1B,CADK,EAEL,WAAW,IAAX,CAAgB,QAAhB,EAA0B,KAA1B,EAFK,CAAP;AAID;;AApFH;AAAA;;AAAA;AAAA,EAA4C,cAA5C","file":"/packages/easysearch:core/lib/engines/mongo-db.js.map","sourcesContent":["/**\n * The MongoDBEngine lets you search the index on the server side with MongoDB. Subscriptions and publications\n * are handled within the Engine.\n *\n * @type {MongoDBEngine}\n */\nMongoDBEngine = class MongoDBEngine extends ReactiveEngine {\n  /**\n   * Return default configuration.\n   *\n   * @returns {Object}\n   */\n  defaultConfiguration() {\n    return _.defaults({}, MongoDBEngine.defaultMongoConfiguration(this), super.defaultConfiguration());\n  }\n\n  /**\n   * Default mongo configuration, used in constructor and MinimongoEngine to get the configuration.\n   *\n   * @param {Object} engineScope Scope of the engine\n   *\n   * @returns {Object}\n   */\n  static defaultMongoConfiguration(engineScope) {\n    return {\n      aggregation: '$or',\n      selector(searchObject, options, aggregation) {\n        let selector = {};\n\n        selector[aggregation] = [];\n\n        _.each(searchObject, (searchString, field) => {\n          let fieldSelector = engineScope.callConfigMethod(\n            'selectorPerField', field, searchString, options\n          );\n\n          if (fieldSelector) {\n            selector[aggregation].push(fieldSelector);\n          }\n        });\n\n        return selector;\n      },\n      selectorPerField(field, searchString) {\n        let selector = {};\n\n        selector[field] = { '$regex' : `.*${searchString}.*`, '$options' : 'i'};\n\n        return selector\n      },\n      sort(searchObject, options) {\n        return options.index.fields;\n      }\n    };\n  }\n\n  /**\n   * Return the find options for the mongo find query.\n   *\n   * @param {String} searchDefinition Search definition\n   * @param {Object} options          Search and index options\n   */\n  getFindOptions(searchDefinition, options) {\n    return {\n      sort: this.callConfigMethod('sort', searchDefinition, options),\n      limit: options.search.limit,\n      skip: options.search.skip,\n      fields: this.callConfigMethod('fields', searchDefinition, options)\n    };\n  }\n\n  /**\n   * Return the reactive search cursor.\n   *\n   * @param {String} searchDefinition Search definition\n   * @param {Object} options          Search and index options\n   */\n  getSearchCursor(searchDefinition, options) {\n    let selector = this.callConfigMethod('selector', searchDefinition, options, this.config.aggregation),\n      findOptions = this.getFindOptions(searchDefinition, options),\n      collection = options.index.collection;\n\n    check(options, Object);\n    check(selector, Object);\n    check(findOptions, Object);\n\n    return new Cursor(\n      collection.find(selector, findOptions),\n      collection.find(selector).count()\n    );\n  }\n};\n"]},"hash":"8be8dc93e380ca4dce36ce4b30762f2b3f9184e0"}
