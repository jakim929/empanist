{"metadata":{"usedHelpers":["createClass","classCallCheck","interopRequireDefault"],"marked":[],"modules":{"imports":[],"exports":{"exported":[],"specifiers":[]}}},"options":{"filename":"/packages/easysearch:core/lib/core/search-collection.js","filenameRelative":"/packages/easysearch:core/lib/core/search-collection.js","env":{},"retainLines":false,"highlightCode":true,"suppressDeprecationMessages":false,"presets":[],"plugins":[[[],{"polyfill":false}],[[],null],[[],null],[[],{"allowTopLevelThis":true,"strict":false,"loose":true}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"loose":true}],[[],{"loose":true}],[[],null],[[],{"loose":true}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"loose":true}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null]],"ignore":[],"code":true,"metadata":true,"ast":false,"comments":true,"compact":false,"minified":false,"sourceMap":true,"sourceMaps":true,"sourceMapTarget":"/packages/easysearch:core/lib/core/search-collection.js.map","sourceFileName":"/packages/easysearch:core/lib/core/search-collection.js","babelrc":false,"sourceType":"module","moduleIds":false,"passPerPreset":false,"basename":"search-collection"},"ignored":false,"code":"var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');\n\nvar _classCallCheck3 = _interopRequireDefault(_classCallCheck2);\n\nvar _createClass2 = require('babel-runtime/helpers/createClass');\n\nvar _createClass3 = _interopRequireDefault(_createClass2);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }\n\n/**\n * A search collection represents a reactive collection on the client,\n * which is used by the ReactiveEngine for searching.\n *\n * @type {SearchCollection}\n */\nSearchCollection = function () {\n  /**\n   * Constructor\n   *\n   * @param {Object}         indexConfiguration Index configuration\n   * @param {ReactiveEngine} engine             Reactive Engine\n   *\n   * @constructor\n   */\n\n  function SearchCollection(indexConfiguration, engine) {\n    (0, _classCallCheck3['default'])(this, SearchCollection);\n\n    check(indexConfiguration, Object);\n    check(indexConfiguration.name, Match.OneOf(String, null));\n\n    if (!(engine instanceof ReactiveEngine)) {\n      throw new Meteor.Error('invalid-engine', 'engine needs to be instanceof ReactiveEngine');\n    }\n\n    this._indexConfiguration = indexConfiguration;\n    this._name = indexConfiguration.name + '/easySearch';\n    this._engine = engine;\n\n    if (Meteor.isClient) {\n      this._collection = new Meteor.Collection(this._name);\n    } else if (Meteor.isServer) {\n      this._setUpPublication();\n    }\n  }\n\n  /**\n   * Get name\n   *\n   * @returns {String}\n   */\n\n\n  /**\n   * Find documents on the client.\n   *\n   * @param {Object} searchDefinition Search definition\n   * @param {Object} options          Options\n   *\n   * @returns {Cursor}\n   */\n\n  SearchCollection.prototype.find = function () {\n    function find(searchDefinition, options) {\n      if (!Meteor.isClient) {\n        throw new Error('find can only be used on client');\n      }\n\n      var publishHandle = Meteor.subscribe(this.name, searchDefinition, options);\n\n      var count = this._getCount(searchDefinition);\n      var mongoCursor = this._getMongoCursor(searchDefinition, options);\n\n      if (!_.isNumber(count)) {\n        return new Cursor(mongoCursor, 0, false);\n      }\n\n      return new Cursor(mongoCursor, count, true, publishHandle);\n    }\n\n    return find;\n  }();\n\n  /**\n   * Get the count of the cursor.\n   *\n   * @params {Object} searchDefinition Search definition\n   *\n   * @returns {Cursor.count}\n   *\n   * @private\n   */\n\n\n  SearchCollection.prototype._getCount = function () {\n    function _getCount(searchDefinition) {\n      var countDoc = this._collection.findOne('searchCount' + JSON.stringify(searchDefinition));\n\n      if (countDoc) {\n        return countDoc.count;\n      }\n    }\n\n    return _getCount;\n  }();\n\n  /**\n   * Get the mongo cursor.\n   *\n   * @param {Object} searchDefinition Search definition\n   * @param {Object} options          Search options\n   *\n   * @returns {Cursor}\n   * @private\n   */\n\n\n  SearchCollection.prototype._getMongoCursor = function () {\n    function _getMongoCursor(searchDefinition, options) {\n      var _this = this;\n\n      return this._collection.find({ __searchDefinition: JSON.stringify(searchDefinition), __searchOptions: JSON.stringify(options.props) }, {\n        transform: function () {\n          function transform(doc) {\n            delete doc.__searchDefinition;\n            delete doc.__searchOptions;\n            delete doc.__sortPosition;\n\n            doc = _this.engine.config.transform(doc);\n\n            return doc;\n          }\n\n          return transform;\n        }(),\n        sort: ['__sortPosition']\n      });\n    }\n\n    return _getMongoCursor;\n  }();\n\n  /**\n   * Return a unique document id for publication.\n   *\n   * @param {Document} doc\n   *\n   * @returns string\n   */\n\n\n  SearchCollection.prototype.generateId = function () {\n    function generateId(doc) {\n      return doc._id + doc.__searchDefinition + doc.__searchOptions;\n    }\n\n    return generateId;\n  }();\n\n  /**\n   * Add custom fields to the given document\n   *\n   * @param {Document} doc\n   * @param {Object}   data\n   * @returns {*}\n   */\n\n\n  SearchCollection.prototype.addCustomFields = function () {\n    function addCustomFields(doc, data) {\n      _.forEach(data, function (val, key) {\n        doc['__' + key] = val;\n      });\n\n      return doc;\n    }\n\n    return addCustomFields;\n  }();\n\n  /**\n   * Set up publication.\n   *\n   * @private\n   */\n\n\n  SearchCollection.prototype._setUpPublication = function () {\n    function _setUpPublication() {\n      var collectionScope = this,\n          collectionName = this.name;\n\n      Meteor.publish(collectionName, function (searchDefinition, options) {\n        var _this2 = this;\n\n        check(searchDefinition, Match.OneOf(String, Object));\n        check(options, Object);\n\n        var definitionString = JSON.stringify(searchDefinition),\n            optionsString = JSON.stringify(options.props);\n\n        options.userId = this.userId;\n        options.publicationScope = this;\n\n        if (!collectionScope._indexConfiguration.permission(options)) {\n          throw new Meteor.Error('not-allowed', \"You're not allowed to search this index!\");\n        }\n\n        collectionScope.engine.checkSearchParam(searchDefinition, collectionScope._indexConfiguration);\n\n        var cursor = collectionScope.engine.search(searchDefinition, {\n          search: options,\n          index: collectionScope._indexConfiguration\n        });\n\n        var count = cursor.count();\n\n        this.added(collectionName, 'searchCount' + definitionString, { count: count });\n\n        var resultsHandle = cursor.mongoCursor.observe({\n          addedAt: function () {\n            function addedAt(doc, atIndex, before) {\n              doc = collectionScope.engine.config.beforePublish('addedAt', doc, atIndex, before);\n              doc = collectionScope.addCustomFields(doc, {\n                searchDefinition: definitionString,\n                searchOptions: optionsString,\n                sortPosition: atIndex,\n                originalId: doc._id\n              });\n\n              _this2.added(collectionName, collectionScope.generateId(doc), doc);\n            }\n\n            return addedAt;\n          }(),\n          changedAt: function () {\n            function changedAt(doc, oldDoc, atIndex) {\n              doc = collectionScope.engine.config.beforePublish('changedAt', doc, oldDoc, atIndex);\n              doc = collectionScope.addCustomFields(doc, {\n                searchDefinition: definitionString,\n                searchOptions: optionsString,\n                sortPosition: atIndex,\n                originalId: doc._id\n              });\n\n              _this2.changed(collectionName, collectionScope.generateId(doc), doc);\n            }\n\n            return changedAt;\n          }(),\n          movedTo: function () {\n            function movedTo(doc, fromIndex, toIndex, before) {\n              doc = collectionScope.engine.config.beforePublish('movedTo', doc, fromIndex, toIndex, before);\n              doc = collectionScope.addCustomFields(doc, {\n                searchDefinition: definitionString,\n                searchOptions: optionsString,\n                sortPosition: toIndex\n              });\n\n              var beforeDoc = collectionScope._indexConfiguration.collection.findOne(before);\n\n              if (beforeDoc) {\n                beforeDoc = collectionScope.addCustomFields(beforeDoc, {\n                  searchDefinition: definitionString,\n                  searchOptions: optionsString,\n                  sortPosition: fromIndex\n                });\n                _this2.changed(collectionName, collectionScope.generateId(beforeDoc), beforeDoc);\n              }\n\n              _this2.changed(collectionName, collectionScope.generateId(doc), doc);\n            }\n\n            return movedTo;\n          }(),\n          removedAt: function () {\n            function removedAt(doc, atIndex) {\n              doc = collectionScope.engine.config.beforePublish('removedAt', doc, atIndex);\n              doc = collectionScope.addCustomFields(doc, { searchDefinition: definitionString, searchOptions: optionsString });\n              _this2.removed(collectionName, collectionScope.generateId(doc));\n            }\n\n            return removedAt;\n          }()\n        });\n\n        this.onStop(function () {\n          resultsHandle.stop();\n        });\n\n        this.ready();\n      });\n    }\n\n    return _setUpPublication;\n  }();\n\n  (0, _createClass3['default'])(SearchCollection, [{\n    key: 'name',\n    get: function () {\n      function get() {\n        return this._name;\n      }\n\n      return get;\n    }()\n\n    /**\n     * Get engine\n     *\n     * @returns {ReactiveEngine}\n     */\n\n  }, {\n    key: 'engine',\n    get: function () {\n      function get() {\n        return this._engine;\n      }\n\n      return get;\n    }()\n  }]);\n  return SearchCollection;\n}();","ast":null,"map":{"version":3,"sources":["/packages/easysearch:core/lib/core/search-collection.js"],"names":[],"mappings":"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","file":"/packages/easysearch:core/lib/core/search-collection.js.map","sourcesContent":["/**\n * A search collection represents a reactive collection on the client,\n * which is used by the ReactiveEngine for searching.\n *\n * @type {SearchCollection}\n */\nSearchCollection = class SearchCollection {\n  /**\n   * Constructor\n   *\n   * @param {Object}         indexConfiguration Index configuration\n   * @param {ReactiveEngine} engine             Reactive Engine\n   *\n   * @constructor\n   */\n  constructor(indexConfiguration, engine) {\n    check(indexConfiguration, Object);\n    check(indexConfiguration.name, Match.OneOf(String, null));\n\n    if (!(engine instanceof ReactiveEngine)) {\n      throw new Meteor.Error('invalid-engine', 'engine needs to be instanceof ReactiveEngine');\n    }\n\n    this._indexConfiguration = indexConfiguration;\n    this._name = `${indexConfiguration.name}/easySearch`;\n    this._engine = engine;\n\n    if (Meteor.isClient) {\n      this._collection = new Meteor.Collection(this._name);\n    } else if (Meteor.isServer) {\n      this._setUpPublication();\n    }\n  }\n\n  /**\n   * Get name\n   *\n   * @returns {String}\n   */\n  get name() {\n    return this._name;\n  }\n\n  /**\n   * Get engine\n   *\n   * @returns {ReactiveEngine}\n   */\n  get engine() {\n    return this._engine;\n  }\n\n  /**\n   * Find documents on the client.\n   *\n   * @param {Object} searchDefinition Search definition\n   * @param {Object} options          Options\n   *\n   * @returns {Cursor}\n   */\n  find(searchDefinition, options) {\n    if (!Meteor.isClient) {\n      throw new Error('find can only be used on client');\n    }\n\n    let publishHandle = Meteor.subscribe(this.name, searchDefinition, options);\n\n    let count = this._getCount(searchDefinition);\n    let mongoCursor = this._getMongoCursor(searchDefinition, options);\n\n    if (!_.isNumber(count)) {\n      return new Cursor(mongoCursor, 0, false);\n    }\n\n    return new Cursor(mongoCursor, count, true, publishHandle);\n  }\n\n  /**\n   * Get the count of the cursor.\n   *\n   * @params {Object} searchDefinition Search definition\n   *\n   * @returns {Cursor.count}\n   *\n   * @private\n   */\n  _getCount(searchDefinition) {\n    let countDoc = this._collection.findOne('searchCount' + JSON.stringify(searchDefinition));\n\n    if (countDoc) {\n      return countDoc.count;\n    }\n  }\n\n  /**\n   * Get the mongo cursor.\n   *\n   * @param {Object} searchDefinition Search definition\n   * @param {Object} options          Search options\n   *\n   * @returns {Cursor}\n   * @private\n   */\n  _getMongoCursor(searchDefinition, options) {\n    return this._collection.find(\n      { __searchDefinition: JSON.stringify(searchDefinition), __searchOptions: JSON.stringify(options.props) },\n      {\n        transform: (doc) => {\n          delete doc.__searchDefinition;\n          delete doc.__searchOptions;\n          delete doc.__sortPosition;\n\n          doc = this.engine.config.transform(doc);\n\n          return doc;\n        },\n        sort: ['__sortPosition']\n      }\n    );\n  }\n\n  /**\n   * Return a unique document id for publication.\n   *\n   * @param {Document} doc\n   *\n   * @returns string\n   */\n  generateId(doc) {\n    return doc._id + doc.__searchDefinition + doc.__searchOptions;\n  }\n\n  /**\n   * Add custom fields to the given document\n   *\n   * @param {Document} doc\n   * @param {Object}   data\n   * @returns {*}\n   */\n  addCustomFields(doc, data) {\n    _.forEach(data, function (val, key) {\n      doc['__' + key] = val;\n    });\n\n    return doc;\n  }\n\n  /**\n   * Set up publication.\n   *\n   * @private\n   */\n  _setUpPublication() {\n    var collectionScope = this,\n      collectionName = this.name;\n\n    Meteor.publish(collectionName, function (searchDefinition, options) {\n      check(searchDefinition, Match.OneOf(String, Object));\n      check(options, Object);\n\n      let definitionString = JSON.stringify(searchDefinition),\n        optionsString = JSON.stringify(options.props);\n\n      options.userId = this.userId;\n      options.publicationScope = this;\n\n      if (!collectionScope._indexConfiguration.permission(options)) {\n        throw new Meteor.Error('not-allowed', \"You're not allowed to search this index!\");\n      }\n\n      collectionScope.engine.checkSearchParam(searchDefinition, collectionScope._indexConfiguration);\n\n      let cursor = collectionScope.engine.search(searchDefinition, {\n        search: options,\n        index: collectionScope._indexConfiguration\n      });\n\n      const count = cursor.count();\n\n      this.added(collectionName, 'searchCount' + definitionString, { count: count });\n\n      let resultsHandle = cursor.mongoCursor.observe({\n        addedAt: (doc, atIndex, before) => {\n          doc = collectionScope.engine.config.beforePublish('addedAt', doc, atIndex, before);\n          doc = collectionScope.addCustomFields(doc, {\n            searchDefinition: definitionString,\n            searchOptions: optionsString,\n            sortPosition: atIndex,\n            originalId: doc._id\n          });\n\n          this.added(collectionName, collectionScope.generateId(doc), doc);\n        },\n        changedAt: (doc, oldDoc, atIndex) => {\n          doc = collectionScope.engine.config.beforePublish('changedAt', doc, oldDoc, atIndex);\n          doc = collectionScope.addCustomFields(doc, {\n            searchDefinition: definitionString,\n            searchOptions: optionsString,\n            sortPosition: atIndex,\n            originalId: doc._id\n          });\n\n          this.changed(collectionName, collectionScope.generateId(doc), doc)\n        },\n        movedTo: (doc, fromIndex, toIndex, before) => {\n          doc = collectionScope.engine.config.beforePublish('movedTo', doc, fromIndex, toIndex, before);\n          doc = collectionScope.addCustomFields(doc, {\n            searchDefinition: definitionString,\n            searchOptions: optionsString,\n            sortPosition: toIndex\n          });\n\n          let beforeDoc = collectionScope._indexConfiguration.collection.findOne(before);\n\n          if (beforeDoc) {\n            beforeDoc = collectionScope.addCustomFields(beforeDoc, {\n              searchDefinition: definitionString,\n              searchOptions: optionsString,\n              sortPosition: fromIndex\n            });\n            this.changed(collectionName, collectionScope.generateId(beforeDoc), beforeDoc);\n          }\n\n          this.changed(collectionName, collectionScope.generateId(doc), doc);\n        },\n        removedAt: (doc, atIndex) => {\n          doc = collectionScope.engine.config.beforePublish('removedAt', doc, atIndex);\n          doc = collectionScope.addCustomFields(doc, { searchDefinition: definitionString, searchOptions: optionsString });\n          this.removed(collectionName, collectionScope.generateId(doc));\n        }\n      });\n\n      this.onStop(function () {\n        resultsHandle.stop();\n      });\n\n      this.ready();\n    });\n  }\n};\n"]},"hash":"42c5372b6bb077f6b69eae953e7a97f0c0eb4c95"}
